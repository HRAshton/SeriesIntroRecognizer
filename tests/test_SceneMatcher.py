from imagehash import hex_to_hash
from scenedetect import FrameTimecode

from src import find_similar_scenes, HashedScene, Scene

frame_rate = 23.976023976023978


def test_find_common_scenes_result_should_contain_beginning_and_ending():
    testdata = get_test_data()

    result = find_similar_scenes(testdata[0], testdata[1])

    beginning = filter(lambda x: x[0].start.frame_num == 1027 and x[1].start.frame_num == 2465, result)
    ending = filter(lambda x: x[0].start.frame_num == 3110 and x[1].start.frame_num == 4548, result)

    assert len(list(beginning)) == 1
    assert len(list(ending)) == 1


def get_test_data() -> tuple[list[HashedScene], list[HashedScene]]:
    video1_frames = [
        (0, 71, '0000000000000000'), (71, 156, '0c3c3c3e3e1e1e1c'), (156, 224, '18181c3c3c7c7efe'),
        (224, 324, '18383c3c3cfefffe'), (324, 572, '0000000000000000'), (572, 632, '38783c7e7e18187c'),
        (632, 750, 'fcdc9c3c2d0f0800'), (750, 888, 'e1c1f9fdededf9e0'), (888, 1008, 'fffffaba10045050'),
        (1008, 1027, '0000000f1f7fffff'), (1027, 1061, 'cdcf0901fffb8000'), (1061, 1084, '00001c1e1e1e5e6d'),
        (1084, 1114, '1030461c1e1d6c42'), (1114, 1143, 'fe3d3f1f0d016703'), (1143, 1177, 'fef08086eee00002'),
        (1177, 1235, '7f7ffffedc000000'), (1235, 1261, '477f7f7f1f000000'), (1261, 1360, '475f7f1f1f030101'),
        (1360, 1469, '0101032737660c0c'), (1469, 1490, 'ffffeffffad0c0c0'), (1490, 1611, '7fe7ffe7c1808000'),
        (1611, 1713, 'fffffdd980102000'), (1713, 1743, '767d7dbc7c240c0c'), (1743, 1758, '1f1f1f3f77040000'),
        (1758, 1775, 'fefededec6c60000'), (1775, 1791, 'fffdfdfc78083838'), (1791, 1807, '3e3f3e243c3d3c18'),
        (1807, 1823, 'ff7fef131d054040'), (1823, 1844, '3c3c3c66667e7e42'), (1844, 1873, '3f7ffffffe380000'),
        (1873, 1902, 'f1f1f3f9fbf02160'), (1902, 1952, '1818fce460e77e7e'), (1952, 1999, '00181c7e7e7e7c3c'),
        (1999, 2064, '040406179fcfe766'), (2064, 2139, '78feffffffff0000'), (2139, 2154, 'e020017ffffc3918'),
        (2154, 2197, '034747e9e02007ff'), (2197, 2215, 'b7b7b7b732000303'), (2215, 2230, '7f5f1e1e10102026'),
        (2230, 2249, '0707bfffbf070300'), (2249, 2264, '939380c8ccfef878'), (2264, 2279, 'cbcefffdc1e0e040'),
        (2279, 2301, '002859c8dc1edff7'), (2301, 2317, '10141c1c3e3e3e3e'), (2317, 2337, 'e1e1e1ebf3f7c68e'),
        (2337, 2352, 'c1e573391d5e1301'), (2352, 2368, '083839fddbf3e1e1'), (2368, 2383, 'ffffffffe7e7e7e7'),
        (2383, 2401, '0001010101fcfeff'), (2401, 2417, '0303032300deffff'), (2417, 2433, '0000002000f9ffff'),
        (2433, 2460, '0002062202f8fcfc'), (2460, 2515, 'c0c26676766e6c3c'), (2515, 2531, '1c7e3c3424060e3e'),
        (2531, 2547, '3a3e3e1a1a020c1c'), (2547, 2617, '7e7e7e7e7e3e3e1c'), (2617, 2644, '10383c7e7a3e6626'),
        (2644, 2677, '003e3e7e7c6c200c'), (2677, 2695, 'ffff7c7860000000'), (2695, 2727, '00c35efefe6c0000'),
        (2727, 2743, '0030383cfcfefec7'), (2743, 2763, '00008080c1e4fefe'), (2763, 2787, '08ce0fdcfc7c6040'),
        (2787, 2803, '1f1f1f1e1e1e1f1f'), (2803, 2827, '77ef6e2f22000000'), (2827, 2842, '1c3c3c1e00026f6f'),
        (2842, 2860, 'd0b3af2e36347c79'), (2860, 2902, '00171f1e0c8c0736'), (2902, 2917, '001c1c1c0802377f'),
        (2917, 2935, '00000070f8f8ffff'), (2935, 3020, '00133f7f7f7d0000'), (3020, 3082, 'ff0300e0f21f1400'),
        (3082, 3110, 'e7c3f7f7c7878705'), (3110, 3165, 'ce7e70f8fcf86000'), (3165, 3229, 'e342c25cb8abab00'),
        (3229, 3366, 'f6e6f6e620000287'), (3366, 3510, 'c7c7cf9f1f300400'), (3510, 3546, 'ffff9fd18482808d'),
        (3546, 3591, '7f7f4f4044c3c1cd'), (3591, 3645, 'ff6f7f6744606020'), (3645, 3738, '7999ed3f7d7e3c80'),
        (3738, 3858, 'fcfffdbf3d2000e0'), (3858, 4023, '1818183c3c3c3c3e'), (4023, 4362, 'ffbfffbf1f160000'),
        (4362, 4472, 'f898f8f8b8189c78'), (4472, 4590, 'b9b1f1f939393950'), (4590, 4809, 'ffffd69690c0c8c0'),
        (4809, 4857, '183c3e3e7e3c380a'), (4857, 4914, 'ffe7df7f6fc70302'), (4914, 5097, 'ffe7673fcec34300'),
        (5097, 5274, 'ffffff830383c0e0'), (5274, 5418, 'ffff5f3ebc100000'), (5418, 5496, '00187e7f7f7f7f7f'),
        (5496, 5720, '30307c7c3e3cb181'), (5720, 5796, '050f4f6767470707'), (5796, 5897, 'ffffe1e1e0e0c042'),
        (5897, 5993, 'ffffffcf9f180000'), (5993, 6041, '3f3f0f67e7f3e180'), (6041, 6075, '3b706001a7fdfcf8'),
        (6075, 6170, 'ffff3c003c7c8000'), (6170, 6248, '0002c7f7f3e3c3c3'), (6248, 6386, '0f1e1e9f99998989'),
        (6386, 6430, '0000e1f7f7f3e3e3'), (6430, 6512, '0004e2f0f2f5e4e0'), (6512, 6548, '9afe793fe7a6e727'),
        (6548, 6788, 'ffffffe90840000c'), (6788, 6944, 'ff2f0f0f1f0f2200'), (6944, 7136, 'fffcbc3e7e380800'),
        (7136, 7262, 'fffb993d70303000'), (7262, 7298, 'fcf8b0f0f0f8f8bc'), (7298, 7313, '08643e7a3878dc9c'),
        (7313, 7334, '0e267e7a7a3a1c18'), (7334, 7514, '3f3e3f6e6b6e2200'), (7514, 7586, 'ffd78707260e0e0c'),
        (7586, 7646, '2c383c3838181810'), (7646, 7730, '3f7f677c7e7c0800'), (7730, 7832, '274341dcf8e8dfc1'),
        (7832, 7906, '7f1f3f3d3c200100'), (7906, 8076, '76276f8d1c387cf4'), (8076, 8206, '3f3fffc6ca0b0e04'),
        (8206, 8276, '3c383c3c2c663d3c'), (8276, 8498, '3e3e1a1e9659f86c'), (8498, 8624, 'fffffffff3000000'),
        (8624, 8872, '5858b0f0fffff600'), (8872, 8988, '7f1ccbefcb480000'), (8988, 9152, '7f18ebefe3720000'),
        (9152, 9202, '0000000000000000'), (9202, 9230, 'e0e0c1c1c17313ff'), (9230, 9245, '8000008086bdbfe7'),
        (9245, 9287, '1f1a100010127eff'), (9287, 9407, 'f806fffff6fa0000'), (9407, 9509, '0f803f37372f0818'),
        (9509, 9731, 'fffff3a391810000'), (9731, 9892, 'f7c3c38381819d9d'), (9892, 9947, 'c3c1c1c9d9ddd999'),
        (9947, 10025, 'ffffffdf08180000'), (10025, 10055, '0000000000000000'), (10055, 10089, '20206677f7ffff7f'),
        (10089, 10116, 'ffffe40000011913'), (10116, 10143, 'ffff1e006187841a'), (10143, 10170, 'fffffbf9f0000001'),
        (10170, 10206, 'ffffbf0022a28023'), (10206, 10374, 'e7e7e7ffe7c34343'), (10374, 10487, 'ffffe0e0c080e0df'),
        (10487, 10547, 'ffffe7840080c2fb'), (10547, 10631, 'ffffe3c3c1c0c000'), (10631, 10699, 'ffff1f050400021e'),
        (10699, 10769, 'ffff3f2f01103013'), (10769, 10889, '70525a52f2e3e3e3'), (10889, 10961, '1c3c3e3e2e343414'),
        (10961, 11039, '70263c36e67e4604'), (11039, 11123, '70747c6f2e0c0c0c'), (11123, 11211, 'ffffbb13b1110900'),
        (11211, 11391, 'fefc1c3e3e7e4400'), (11391, 11457, 'e7c3c3c3f3f3e7f3'), (11457, 11487, '080c0e6f677f7e7e'),
        (11487, 11535, 'e0a888eb7b059d18'), (11535, 11655, 'ffff7cf080800904'), (11655, 11734, 'e7e7e7ffe7e7c3c3'),
        (11734, 11882, '0f0f0f1f1f1f0707'), (11882, 12023, '40400d0f0eff7f7f'), (12023, 12219, 'ff6767677ef00000'),
        (12219, 12339, 'ffffc1e1f1c94940'), (12339, 12531, 'ff7fffff7d080000'), (12531, 12591, '0060fffbf9f9f909'),
        (12591, 12663, '7e2626267ec3c3c3'), (12663, 12696, '0000000000000000'), (12696, 12714, '08060f6f7f7f7f7f'),
        (12714, 12739, 'c6c47c3e1c363620'), (12739, 12847, '0000000000000000')
    ]

    video2_frames = [
        (0, 16, '0c08988081f9fbdb'), (16, 32, 'e0e120382b2f7ef9'), (32, 48, 'e6e6fcfde5a1b1b2'),
        (48, 63, '2624e4fc67a7b6f4'), (63, 117, '4067777efe74643c'), (117, 204, '0000377ffe7c3c38'),
        (204, 245, 'bf3f0f0f0f070704'), (245, 264, '0707030301010303'), (264, 299, '0b08071f18110101'),
        (299, 347, '1f1f060e1f77e313'), (347, 394, '1f18081801818383'), (394, 436, 'ffef830105054468'),
        (436, 453, '889d9cda3ebeb7e1'), (453, 468, '989d9cd83ebfb7e1'), (468, 483, '8c9c9eda5c3d94f0'),
        (483, 515, 'ffffdcee9c0c0044'), (515, 572, 'd8c01898db9818bd'), (572, 648, 'ffcf0e1193c00c3e'),
        (648, 729, 'f1f1796971302000'), (729, 801, '7f67607466626200'), (801, 921, '183c3c3c3c3c3e06'),
        (921, 994, 'fefefe9a1a000000'), (994, 1043, 'f674363616363606'), (1043, 1118, '34081c1c1c181f3f'),
        (1118, 1205, 'ffbcb484878f8981'), (1205, 1277, '6a78848c3d1e9c80'), (1277, 1361, '00000818183d3fff'),
        (1361, 1397, 'c3cb9fbf83838303'), (1397, 1487, 'fe76666260202121'), (1487, 1657, 'ffdb9bbf9b080301'),
        (1657, 1714, '44041e6ee0f86000'), (1714, 1759, 'fefedede1c103800'), (1759, 1909, 'ff3f3f3f3b0e0000'),
        (1909, 2017, 'bebe9ebe18102018'), (2017, 2092, 'ff7f0604810104f8'), (2092, 2188, 'c0e0c0de58f8b490'),
        (2188, 2278, 'fcfcfcecd8180000'), (2278, 2465, 'e0e0e0e0e090c0c0'), (2465, 2499, 'cdcf0901fffb8000'),
        (2499, 2522, '00001c1e1e1e5e6d'), (2522, 2552, '1030461c1e1d6c42'), (2552, 2581, 'fe3d3f1e0d016703'),
        (2581, 2615, 'fef08086eee00002'), (2615, 2673, '7f7ffffedc000000'), (2673, 2699, '477f7f7f1f000000'),
        (2699, 2798, '475f7f1f1f030101'), (2798, 2907, '0101032737660c0c'), (2907, 2928, 'ffffeffffad0c0c0'),
        (2928, 3049, '7fe7ffe7c1808000'), (3049, 3151, 'fffffdd980102000'), (3151, 3181, '76fd7dbc7c240c0c'),
        (3181, 3196, '1f1f1f3f77040000'), (3196, 3213, 'fefededec6c60000'), (3213, 3229, 'fffdfdfc78083838'),
        (3229, 3245, '3e3f3e243c3d3c18'), (3245, 3261, 'ff7fef131d054040'), (3261, 3282, '3c3c3c66667e7e42'),
        (3282, 3311, '3f7ffffffe380000'), (3311, 3340, 'f1f1f3f9fbf02160'), (3340, 3390, '1818fce460e77e7e'),
        (3390, 3419, '00181c7e7e7e7c3c'), (3419, 3437, '20c2c2d2e7ff7f7f'), (3437, 3502, '040406179fcfe766'),
        (3502, 3577, '78feffffffff0000'), (3577, 3592, 'e020017ffffc3918'), (3592, 3635, '034747e9e02007ff'),
        (3635, 3653, 'b7b7b7b732000303'), (3653, 3668, '7f5f1e1e10102026'), (3668, 3687, '0707bfffbf070300'),
        (3687, 3702, '939380c8ccfef878'), (3702, 3717, 'cbcefffdc1e0e040'), (3717, 3739, '002859c8dc1edff7'),
        (3739, 3755, '10141c1c3e3e3e3e'), (3755, 3775, 'e1e1e1ebf3f7c68e'), (3775, 3790, 'c1e573391d5e1301'),
        (3790, 3806, '083839fddbf3e1e1'), (3806, 3821, 'ffffffffe7e7e7e7'), (3821, 3839, '0001010101fcfeff'),
        (3839, 3855, '0303032300deffff'), (3855, 3871, '0000002000f9ffff'), (3871, 3898, '0002062202f8fcfc'),
        (3898, 3953, 'c0c26676766e6c3c'), (3953, 3969, '1c7e3c3424060e3e'), (3969, 3985, '3a3e3e1a1a020c1c'),
        (3985, 4055, '7e7e7e7e7e3e3e1c'), (4055, 4082, '10383c7e7a3e6626'), (4082, 4115, '003e3e7e7c6c200c'),
        (4115, 4133, 'ffff7c7860000000'), (4133, 4165, '00c35efefe6c0000'), (4165, 4181, '0030383cfcfefec7'),
        (4181, 4201, '00008080c1e4fefe'), (4201, 4225, '08ce0fdcfc7c6040'), (4225, 4241, '1f1f1f1e1e1e1f1f'),
        (4241, 4265, '77ef6e2f22000000'), (4265, 4280, '1c3c3c1e00026f6f'), (4280, 4298, 'd0b3af2e36347c79'),
        (4298, 4340, '00171f1e0c8c0736'), (4340, 4355, '001c1c1c0802377f'), (4355, 4373, '00000070f8f8ffff'),
        (4373, 4458, '00133f7f7f7d0000'), (4458, 4520, 'ff0300e0f21f1400'), (4520, 4548, 'e7c3f7f7c7878705'),
        (4548, 4603, 'ce7e70f8fcf86000'), (4603, 4699, 'c0c0e4a6a4e0f47c'), (4699, 4825, 'f7f73f9898981818'),
        (4825, 4975, '0f7f7f6f0f0e0004'), (4975, 5128, 'c78f9fb818307070'), (5128, 5230, '00051f3f3d797fe4'),
        (5230, 5365, 'c3c38ff838107078'), (5365, 5464, '0f7f7f6f0f0e0206'), (5464, 5543, '00084e6fe7f77f7f'),
        (5543, 5609, 'fffbfb5918101000'), (5609, 5651, 'fdf0f0c4d4040000'), (5651, 5704, '00001c5e7e3e3e36'),
        (5704, 5768, '60c2c3b3ffe74242'), (5768, 5827, 'ff7f3c3410051000'), (5827, 5842, '0e1f3f2f0f070300'),
        (5842, 5857, '71612161717f7f28'), (5857, 5874, '3e7273737b020202'), (5874, 5910, '787cf0e0e1070f0f'),
        (5910, 5945, 'fcfc9c0c0c080809'), (5945, 5971, 'bf273f1f8c000005'), (5971, 5995, '7f7f0f1d31606000'),
        (5995, 6103, 'fffefe0000240000'), (6103, 6181, 'be3e3f3d3c480000'), (6181, 6241, 'fefc7c243c1c1c00'),
        (6241, 6262, 'bc787172e5cf1f1e'), (6262, 6278, 'fdfcfefa10000000'), (6278, 6311, '9fbe1c3c3cd49404'),
        (6311, 6359, '0000000000000000'), (6359, 6452, 'ffef8e0707060400'), (6452, 6510, 'fffcf8f898000090'),
        (6510, 6602, 'fffe381818180800'), (6602, 6647, 'fc793d383061803c'), (6647, 6722, 'fffc0c1c1c1c8080'),
        (6722, 6746, '870f2f2e3efe7c00'), (6746, 6859, 'ffffe7e2c8800000'), (6859, 6929, '1f7f1f3f7e2c2000'),
        (6929, 7013, '000040e6e7e7c3e7'), (7013, 7241, '3979fbf9fad80000'), (7241, 7316, 'ffff7f3f3f3f0703'),
        (7316, 7391, '1cfcf8fcbc1c1818'), (7391, 7482, 'fcf9fdf880000000'), (7482, 7662, '6064e4e4e6f7f6d6'),
        (7662, 7794, 'e8f8fcfefe7c0000'), (7794, 7842, '80e2ff9b9bdb83c3'), (7842, 7965, '2060746476f6f604'),
        (7965, 8232, '0020fcfefea6a6e4'), (8232, 8277, '0000ecfc7d3ffff8'), (8277, 8334, 'f0c0b2f2b3e36373'),
        (8334, 8385, '0000001c3e7effff'), (8385, 8541, 'f2b2923372724063'), (8541, 8607, '000000183e7e7eff'),
        (8607, 8727, 'c3c9696961616767'), (8727, 8781, '000000003c7efeff'), (8781, 8922, '1b3b3f7e7878f8f8'),
        (8922, 9114, 'd0c0d2f2f2d27272'), (9114, 9210, '808098999f9f9f9f'), (9210, 9267, '3e3e3e1edccce0f0'),
        (9267, 9321, '0002ca9b9b9b9b93'), (9321, 9429, 'e0868e0e8e8e6e7e'), (9429, 9489, '1c5cfcfcf8200080'),
        (9489, 9561, 'b8a8b0b8989cbcbc'), (9561, 9585, '0000000000000000'), (9585, 9672, '8d8dddfc70000030'),
        (9672, 9729, '809d9ddd9d818080'), (9729, 9777, '6363c367231898b0'), (9777, 9855, '6000070f3f3f2f24'),
        (9855, 9903, 'c0c0d8f8fcfcfcf8'), (9903, 10102, '000d7f7b7b3b1b02'), (10102, 10204, '307878fcfcd87170'),
        (10204, 10374, 'c6a381a5a4cce424'), (10374, 10470, '30787cfcfcdc7170'), (10470, 10686, 'f9fdfd3e14010060'),
        (10686, 10785, '70f0f1f1856171f0'), (10785, 10848, '000e060c0c2c7e7e'), (10848, 10911, '00181e1e1f3f3e1a'),
        (10911, 10962, '1f1f1f5f7e606203'), (10962, 11166, '18fcbebcfcfce080'), (11166, 11301, '1f1f1f1f1f010133'),
        (11301, 11391, '038fc78f8f878e84'), (11391, 11601, '096ddc3470f8f080'), (11601, 11715, 'f8f0c4fcf8784000'),
        (11715, 11871, '83878185878f8f8f'), (11871, 11943, '0101151d3d3d7f79'), (11943, 12019, '3c7e66627a7b3f3f'),
        (12019, 12040, '03131b1f1f17175f'), (12040, 12085, '0303034be7efdfdf'), (12085, 12268, '0000ff7e7c1c1c10'),
        (12268, 12514, 'fcfc7830004e4400'), (12514, 12715, '7878786824307070'), (12715, 12772, '504040a0fede9c87'),
        (12772, 12868, '3f1b131f1f1d1d1c'), (12868, 12988, '606060e0f0f0f0f3'), (12988, 13384, '207a6c70f010f8f9'),
        (13384, 13444, '103c6e787c7c7c7c'), (13444, 13681, '3f3f3e3e1e000000'), (13681, 13714, '030307070707277f'),
        (13714, 13813, 'fffdfd9d18000000'), (13813, 13918, 'fbf3ff0f06000000'), (13918, 13996, '8f878f9f979b999c'),
        (13996, 14305, 'f7f7e76929202000'), (14305, 14419, 'fc886e6e7c767620'), (14419, 14515, 'fd8595bd3c3c181c'),
        (14515, 14637, '0000000000000000'), (14637, 14820, 'e1f0e0e4f60e0e8e'), (14820, 15054, '0000000000000000'),
        (15054, 15159, '0101010041d9d9f1'), (15159, 15210, '0000000000000000'), (15210, 15503, '1f0f0b0b8b8a8283'),
        (15503, 15572, '0000000000000000'), (15572, 15629, '030101030f1f3c78'), (15629, 15728, '38383838381e6c60'),
        (15728, 15788, '8f878f8f9b9f9f9c'), (15788, 15866, 'fdfdfde00000f8ff'), (15866, 15956, '00044c7e7f3e3e10'),
        (15956, 16067, '1e3e3c3c2c1c5870'), (16067, 16203, '0000000000000000'), (16203, 16272, '181c7ed8d8083000'),
        (16272, 16449, '101c7e5898080800'), (16449, 16620, '7f1b1f0f0f0f0707'), (16620, 16744, '000f1f7ffefcf000'),
        (16744, 16824, '00010f3f7ef00000')
    ]

    video1_scenes = map(tpl_to_hashed_scene, video1_frames)
    video2_scenes = map(tpl_to_hashed_scene, video2_frames)

    return list(video1_scenes), list(video2_scenes)


def tpl_to_hashed_scene(tpl: tuple[int, int, str]) -> HashedScene:
    return HashedScene(Scene(FrameTimecode(tpl[0], frame_rate),
                             FrameTimecode(tpl[1], frame_rate)),
                       hex_to_hash(tpl[2]))
